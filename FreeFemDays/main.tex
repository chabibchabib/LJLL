\documentclass[8pt, xcolor=table,aspectratio=169]{beamer}

\input{header}

\newif\ifbackup
\backupfalse

\newif\ifDGslide
\DGslidetrue

\setbeamertemplate{section in toc}[sections numbered]
%% Initialize a custom counter for tracking the section numbers

% Customize the table of contents spacing
%\setbeamertemplate{section in toc}[] % Remove numbers and add ball for sections
%\setbeamertemplate{subsection in toc}[default] % Default style for subsections

% Adjust spacing between sections and subsections
\setlength{\leftskip}{0pt} % Set left margin for TOC
\setlength{\rightskip}{0pt} % Set right margin for TOC
\setlength{\parskip}{2mm} % Space between paragraphs in TOC (sections and subsections)

% Define colors for active and inactive sections
\definecolor{activecolor}{rgb}{1,1,0} % yellow
\definecolor{inactivecolor}{rgb}{0.6, 0.6, 0.6} % equivalent to black!40

\setbeamertemplate{section in toc shaded}[default][100]

% Use \AtBeginSection to customize the TOC slide
\AtBeginSection[]{
    % Change the background color for the TOC slide
    \setbeamercolor{background canvas}{bg=colorStruct} % Set TOC background color
    \setbeamertemplate{footline}{} % Suppress footline (including frame number)
    \begin{frame}[noframenumbering]
      \frametitle{Outline}
      \setbeamercolor{section in toc shaded}{fg=inactivecolor} % Inactive color for shaded sections
      \setbeamercolor{section in toc}{fg=activecolor} % Active color for current section
      \tableofcontents[currentsection, hideothersubsections] % Show current section with hidden subsections
    \end{frame}
    \setbeamertemplate{footline}{\axelfootline} % Reset the footline
    % Reset colors to default after TOC slide
    \setbeamercolor{background canvas}{bg=} % Reset background color
    \setbeamercolor{section in toc}{fg=black} % Reset TOC section color to default
    \setbeamercolor{subsection in toc}{fg=black} % Reset TOC subsection color to default
}

\newcommand{\fluxfigure}{
       \begin{tikzpicture}[xscale=1,yscale=1]
        %\filldraw[color=black, fill=black!10, thick] (0,0) ellipse (1.3 and 0.6);
        \draw[fill=black!5,thick] (0,0) -- (1,0) -- (1.5,0.7) -- (0.5,0.7) -- cycle;
        \draw[thick] (0.5,0.7) -- (1,0);
        \draw[-latex, color=black, thick] (0.6,0.55) -- (0.95,0.80);
        %\draw (0.70,0.12) node {\color{black!50}\footnotesize$K$};
        %\draw (1.03,0.3) node {\color{black!50}\footnotesize$K'$};
        \draw (0.95,0.9) node {\color{black}\scriptsize$\mathbf{n}_{K,F}$};
        \draw (0.70,0.2) node {\scriptsize$F$};
        \draw (0.35,0.15) node {\color{black!75}\footnotesize$K$};
        \draw (1.16,0.53) node {\color{black!75}\footnotesize$K'$};
        \draw[-latex, color=black, thick] (0.80,-0.45) -- (1.50, 0.05);
        \draw[latex-, color=colorTrans, thick] (0.90,-0.65) -- (1.60,-0.15);
        \draw (1.85, 0.17) node {\color{black}$\scriptsize g_{K,F}^{\oplus}$};
        \draw (2.05,-0.75) node
          {\color{colorTrans}$\scriptsize g_{K,F}^{\ominus}\color{black}\ \ (=g_{K',F}^{\oplus})$};
      \end{tikzpicture}
    }

\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\input{00_title.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}{Motivation}
    \begin{center}
    \textbf{Finite element} solution of \textbf{time-harmonic wave propagation problems}
  \end{center}

    \fcolorbox{black}{black!7}{\begin{minipage}{50mm}
        \centering
        \vspace{3mm}
        \textbf{\color{colorStruct}Helmholtz problem:} \\ \vspace{3mm}
        $
          \left\{\;
          \begin{aligned}
             & -\Delta {\color{colorVol}p} - \omega^2 {\color{colorVol}p} = s
             &
             & \text{in $\Omega$}
            \\
             & \text{Boundary conditions}
             &
             & \text{on $\partial\Omega$}
          \end{aligned}
          \right.
        % $ \\ \vspace{3mm}
        % $
        %   \Rightarrow
        %   \quad
        %   \fbox{\hspace{1mm}$\mathbf{\matalg{A}{\color{colorVol}\vecalg{x}} = \vecalg{b}}$\hspace{1mm}}
        $
        \vspace{3mm}
        
        \textbf{{\color{colorStruct}Finite element error:}}
        \vspace{3mm}

        %$ \lVert {\color{colorVol}p} - {\color{colorVol}p_h}\lVert  _{H^1} \leq C_1(\omega h)^k + C_2\omega^{(k+1)}h^k$
        $ \lVert {\color{colorVol}p} - {\color{colorVol}p_h}\lVert  _{H^1} \leq C_\omega h^k\lVert {\color{colorVol}p}\lVert_{H^{k+1}}$

      \end{minipage}}
    \hfill
    \begin{minipage}{35mm}
      \begin{center}
        {\small\color{black!50} Finite element mesh} \vspace{1mm}

        \includegraphics[height=30mm]{figures/intro/turbofan_mesh.png}
      \end{center}
    \end{minipage}
    \hfill
    \begin{minipage}{35mm}
      \begin{center}
        {\small\color{black!50} Numerical field} \vspace{1mm}

        \includegraphics[height=30mm]{figures/intro/turbofan_a2500.png}
      \end{center}
    \end{minipage}
 %\vspace{3mm}

  {
    %\small
    \begin{align}
      \begin{aligned}
        % & \text{Complicated material coefficients $\bmu, \bvepsilon$}
        %\\
         & \text{High frequency {\small(large $\omega$)}}
        \\
         & \text{Phenomena close to resonance}
        \\
        % & \text{Good accuracy}
      \end{aligned}
      \ \ \ \leadsto
      \left\{\ \begin{aligned}
                  & \text{Fine mesh {\small(small $h$)}} \quad \uncover<2>{\textcolor{blue}{\large \checkmark}}
                 \\
                  & \text{High-order basis functions {\small(large $k$)}} \quad \uncover<2>{\textcolor{red}{{\text{X Limited to } P_4} }  }
                 %\\
                  %& \text{Large unstructured sparse system / Many DOFs}
                 %\\
                  %& \textbf{\color{ubuntured}Standard direct/iterative solvers are slow}
               \end{aligned}\right.
    \end{align}
  }

% Dans le cadre de la méthode des éléments finis appliquée, par exemple, à l’équation
%  d’onde de type Helmholtz, l’erreur numérique peut se dégrader de manière significative.
%   Cette détérioration est bien décrite par une inégalité classique qui sépare l’erreur 
%   totale en deux contributions :
% 1-l’erreur d’approximation, liée à la capacité de l’espace discret à représenter la 
% solution exacte, 
% 2-l’erreur de pollution, spécifique aux problèmes oscillatoires et qui 
% augmente avec le nombre d’ondes résolues.
% Pour atténuer cette erreur, une première approche consiste à raffiner le maillage. 
% Bien que ce procédé soit efficace, il peut devenir extrêmement coûteux en termes de 
% mémoire et de temps de calcul, car le raffinement doit compenser la croissance de 
% l’erreur de pollution, qui croît généralement avec un facteur en kh ou k^2h, où k est 
% le nombre d’onde.
% Une alternative plus performante consiste à augmenter l’ordre d’interpolation, 
% c’est-à-dire à utiliser des éléments finis d’ordre élevé (augmentation du paramètre p). 
% Cette stratégie est souvent plus efficace que le simple raffinement du maillage : elle 
% permet de mieux capturer l’oscillation de la solution avec beaucoup moins d’éléments, 
% réduit l’impact de l’erreur de pollution, et améliore la précision globale pour un coût 
% numérique comparable, voire inférieur. En pratique, les méthodes à ordre élevé 
% constituent donc une approche plus adaptée pour les problèmes oscillatoires de 
% type Helmholtz.
\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}{Lagrange FE in \texttt{FreeFem++} I}
  \vspace{0.5cm}
  \begin{minipage}{70mm}
 \verbatiminput{cpp_codes/Element_P4.cpp}
  \end{minipage}
\uncover<2>{
  \begin{tikzpicture}[remember picture, overlay]
      % Place the whole diagram 2cm from top-left
      \node at (current page.north west) [xshift=9.8cm, yshift=-2.5cm] {
          \begin{tikzpicture}
              \draw[color=blue][->, thick] (0,0) -- (1,0) ;
              \node at (1.7,0) {\textcolor{blue}{\# DOF =15}};
          \end{tikzpicture}
      };

      \node at (current page.north west) [xshift=6.8cm, yshift=-2.15cm] {
      \begin{tikzpicture}
          \draw[color=blue][->, thick] (0,0) -- (1,0) ;
          \node at (2.2,0) {\textcolor{blue}{Interpolation order}};
      \end{tikzpicture}
      };

      \node at (current page.north west) [xshift=6.6cm, yshift=-2.82cm] {
      \begin{tikzpicture}
          \draw[color=blue][->, thick] (0,0) -- (1,0) ;
          \node at (2.5,0) {\textcolor{blue}{Topological information}};
      \end{tikzpicture}
      };

      \node at (current page.north west) [xshift=9.2cm, yshift=-3.15cm] {
      \begin{tikzpicture}
          \draw[color=blue][->, thick] (0,0) -- (1,0) ;
          \node at (4.3,0) {\textcolor{blue}{Used to construct normal Not needed for Lagrange}};
      \end{tikzpicture}
      };

      \node at (current page.north west) [xshift=9.8cm, yshift=-3.85cm] {
      \begin{tikzpicture}
          \draw[decorate,color=blue, decoration={brace, amplitude=10pt, mirror}]
          (0,1) -- (0,1.8)  node[midway,right=3mm]{Shape functions: $\displaystyle \Phi _i =\overset{3}{\underset{j=0}{\Pi }} \frac{1}{\texttt{ff[i]}}
          \left (\lambda _{\texttt{nn[i][j]}}-\texttt{aa[i][j]}\right ) $ \texttt{.hpp}};
      \end{tikzpicture}
      };

      \node at (current page.north west) [xshift=7.7cm, yshift=-4.85cm] {
      \begin{tikzpicture}
          \draw[decorate,color=blue, decoration={brace, amplitude=10pt, mirror}]
          (0,1) -- (0,1.8)  node[midway,right=3mm]{Nodes barycentric coordinates \texttt{.hpp}};
      \end{tikzpicture}
      };

      \node at (current page.north west) [xshift=10.1cm, yshift=-5.8cm] {
      \begin{tikzpicture}
          \draw [color=blue, line width=0.5mm](0.4,0) rectangle (6.8,0.5);
          \node[right] at (7,0.25){\textcolor{blue}{Parent class constructor}};
        \end{tikzpicture}
      };
  \end{tikzpicture}

}
\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}{Lagrange FE in \texttt{FreeFem++} II}
  \VerbatimInput[firstline=14,lastline=14]{cpp_codes/Element_P4.cpp}
  \begin{center}
\begin{tabular}{ c c c }
 Argument & Value $P_4$ & Value $P_k$ \\ 
 \hline\\
 \# dof & \texttt{15} & $\displaystyle\frac{(k+1)(k+2)}{2}$ \\  
 Dimension FE & \texttt{1} & \texttt{1}  \\
 Array containing topological information & \texttt{Data} & \texttt{Data}  \\  
 Number of subdivisions for plotting  & \texttt{4} & $k$  \\  
 Number of sub-finite elements & \texttt{1} & \texttt{1}  \\  
 \# dof+ non-symmetric permutation of dofs on edges & \texttt{15+6} & \# dof+ $3\times ( (k \% 2) ? (k- 1) : (k - 2)) $  \\  
 Number of interpolation points & \texttt{15} & $\displaystyle\frac{(k+1)(k+2)}{2}$  \\  
 Normal components array  & \texttt{0} & \texttt{0}  \\  

\end{tabular}
\end{center}
% \begin{itemize}
  % \item 1: scalar function space(not vector field).
  % \item Data: Numbering and relationship between DOFs and nodes.
  % \item 4: To visualize the element, it's subdivided into $k$ sub-elements.
  % \item The 15 points where functions are evaluated to construct the interpolant.
% \end{itemize}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}{Lagrange FE in \texttt{FreeFem++} III}
\begin{minipage}{60mm}
          \begin{figure}
        
         \resizebox{\textwidth}{!}{%
    \input{figures/tikz/numerotation_p4.tikz}
         }
    \end{figure}
\end{minipage}
\hspace{0.1cm}
\begin{minipage}{70mm}
 \verbatiminput{cpp_codes/data_table.cpp}
  % \begin{itemize}
    % \item The vertices are numbered 0, 1, 2
    % \item The nodes of the edges are numbered from 3 to 5
    % \item The internal nodes keep the number 6
    % \uncover<2> {
    % \item Internal points are ordered from top to bottom and from left to right
    % }
  % \end{itemize}
\end{minipage}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]{Shape functions}
  \begin{minipage}{60mm}
          \begin{figure}
        
    %    \begin{center}        
         \resizebox{\textwidth}{!}{%
    \input{figures/tikz/element_p6_Lagrange.tikz}
         }
    %    \end{center}
    %\caption{Finite element $P_6$}


    \end{figure}
\uncover<1>{
  \vspace{-1cm}
  Let $\textcolor[RGB]{255,0,0}{i},\textcolor[RGB]{63,117,5}{j}$, 
  and $\textcolor[RGB]{74,144,226}{k}$ be the barycentric coordinates
  of a given node.
%and $\textcolor[RGB]{255,0,0}{\lambda_0}, \textcolor[RGB]{63,117,5}{\lambda_1}, \textcolor[RGB]{74,144,226}{\lambda_2}$ be the barycentric basis functions.
}
\end{minipage}
\hspace{0.001cm}
\begin{minipage}{60mm}
  \uncover<5>{
  \vspace{0.1cm}
 \verbatiminput{cpp_codes/test.cpp}
  }
\end{minipage}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}{Adding the FE in \texttt{FreeFem++}}
  \vspace{0.5cm}
  \begin{itemize}[label=$\square$, itemsep=5mm]
    \item Declaration of a subclass \texttt{TypeOfFE\_PkLagrange} of \texttt{TypeOfFE}
    \item Dynamic allocation of arrays depending on the interpolation order
    \item Arrays are filled on the fly during the creation of the object.
  \uncover<2->{  
    \item \textbf{Once the attributes are filled, the elements can be added to the DSL using:}
    \verbatiminput{cpp_codes/init_dsl.cpp}
  }

  \uncover<3>{  
    \vspace{0.5 cm}
    \begin{center}\textbf{Integrating polynomials of arbitrary order?}\end{center}
  }
  \end{itemize}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}{Quadrature Formula}
  \begin{block}{Grundmann-Möller quadrature formula}
    Let $s\in \mathbb{N}$, $d=2s+1$, and $n\in\mathbb{N} $ a given dimension. Then:
    $$I_n(f)=\displaystyle \underset{i=0}{\sum^s} (-1)^i 2^{-2s}\frac{(d+n-2i)^d}{i!(d+n-i)!}
    \underset{\begin{subarray}{c}|\bm{\beta}|=s-i \\ \beta_0 \ge \dots \ge \beta_n\end{subarray}}{\sum} \sum f \left 
    (\frac{2\beta _1+1}{d+n-2i}
    ,\dots,\frac{2\beta_n+1}{d+n-2i}\right ) $$
  \quad is an invariant integration formula of degree $d$ for the function $f$ on an $n$-simplex,
    
  \quad where: $\bm{\beta}=(\beta _0,\beta _1,\dots, \beta _n)$, and $|\bm{\beta}|= \beta_0+\beta_1+\cdots +\beta_n$
\end{block}
    \uncover<2>{GM formula:}
\begin{center}
  
  \uncover<2>{
  \begin{minipage}{100mm}
    \begin{itemize}[label=$\square$]
      \item is capable of handling any arbitrary polynomial order
      \item is exact for polynomials of degree $d$
      \item is easily adaptable to any spatial dimension $n$
      \item does not guarantee that all weights are positive
      \item is prone to computational overflow issues
      \item is prone to numerical stability issues 
    \end{itemize}
  \end{minipage}
  \quad
  \begin{minipage}{10mm}
    %\vspace{0.1cm}
    \begin{itemize}[label={}]
      \item \textbf{\textcolor{blue}{\Large \checkmark}}
      \item \textbf{\textcolor{blue}{\Large \checkmark}}
      \item \textbf{\textcolor{blue}{\Large \checkmark}}
      \item \textbf{\textcolor{red}{\Large X}}
      \item \textbf{\textcolor{red}{\Large X}}
      \item \textbf{\textcolor{red}{\Large X}}
    \end{itemize}
    
  \end{minipage}
  }
\end{center}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}{Benchmark}

%------------------------------------------
% Colonne de gauche
%------------------------------------------
\begin{minipage}[h]{0.46\textwidth}
  %\vspace{-1.3cm}
    \begin{block}{Poisson problem}
    $\left\{
        \begin{aligned}
        -\Delta u &= (5\pi)^2 \sin(5\pi x)\sin(5\pi y) 
            && \text{in } \Omega=(0,1)^2, \\
        u &= 0
            && \text{on }\partial\Omega .
        \end{aligned}
    \right.$
    \end{block}
    \begin{figure}
         \centering
    \includegraphics[width=\textwidth]{convergencePk/solution.pdf}
    \captionof{figure}{Exact solution}

    \end{figure}
\end{minipage}
\hspace{0.1cm}
%------------------------------------------
% Colonne de droite
%------------------------------------------
\begin{minipage}[h]{0.50\textwidth}
  \vspace{0.3cm}
    \includegraphics[width=\textwidth]{convergencePk/Poisson_2DC_sanspente.pdf}
\end{minipage}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}{Conclusion}{}
  %\vspace{2cm}
  \begin{center}
    
  \begin{itemize}[label={},itemsep=2em]
    \item \textcolor{blue}{\Large\textbf{\underline{Conclusion:}}}
    \begin{itemize}[label=$\square$,itemsep=1em]
      \item Analysis of the existing 2D  Lagrange finite elements
      \item Design of a generic 2D $P_k$  element inspired by existing elements
      \item Development of associated quadrature formulas
      \item Online documentation on how to add a FE: https://www.ljll.fr/hecht/ftp/old/freefem/old/manual-full.pdf
    \end{itemize}
    \item \textcolor{blue}{\Large\textbf{\underline{Outlooks:}}}
      \begin{itemize}[label=$\square$,itemsep=1em]
      \item More rigorous verification of convergence
      \item Addressing numerical instability in quadrature formulas
      \item Extension to the case of 3D Lagrange
      \end{itemize}
  \end{itemize}
  \end{center}

\end{frame}

\end{document}